---
layout: post
title: Integrating Yahoo r3 with phing
date: '2009-12-21T00:00:00+01:00'
tags:
- yahoor3
- phing
- php
tumblr_url: http://alfonsojimenez.tumblr.com/post/30377240717/integrating-yahoo-r3-with-phing
---
<p><strong>Yahoo r3</strong> is a powerful tool for building websites which could require multiple</p>
<p>languages or dimensions. The <strong>r3</strong> outputs may be plain text files, web templates, configuration files or even source code. Sometimes maintaining a big site translated into different languages can become a nightmare, but <strong>r3</strong> lets you do it on an easy way. It offers a neat and powerful command line interface which will make your life easier. It can also be managed by using a web interface.</p>
<h2><img align="right" src="http://66.media.tumblr.com/tumblr_m9gj4beg521r0bq3n.jpg"/></h2>

<p>I know this could be a somewhat confusing thing to explain, so I’m going to try to give an example of what you can do with it. At <strong>Weblogs SL</strong>, we have a platform which handles instances of 37 blogs in 2 languages (Spanish and Portuguese), so we have to maintain 37×2 = 74 sites. They almost share the same layout</p>
<p>structure, but sometimes we need to make specific changes on certain site (maybe a customized header or sidebar). <strong>r3</strong> lets you do all this kind of things by specializing templates for a particular site/language. Coming back to our example, we have two dimensions: <strong>blog</strong> and <strong>language</strong>. Once we have created the dimensions, we can generate all the templates. These raw templates are <strong>parseable</strong> by the template engine included within our platform, so they are processed by the application afterwards. We can also put all the “static variables” for each blog (such as blog titles, URLs, paths, …) during this pre-build process.<!-- more --></p>
<p>So after far too much research, we came up with <strong>Yahoo r3</strong>, but we still had an itch to scratch: how can we integrate this into our continuous integration workflow? We are using <strong>Phing</strong> (and <em>Java Ant</em>) for building our sites, so it was nice to have some <strong>Phing</strong> tasks to work with <strong>r3</strong>. So I wrote these two tasks:</p>
<h2>r3GenerateTask.php</h2>
<div class="codecolorer-container php blackboard">
<pre class="prettyprint lang-php"><span class="kw1">require_once</span> <span class="st_h">'phing/Task.php'</span><span class="sy0">;</span><br/><span class="co4">/**<br/>  * r3 Generate Task<br/>  *<br/>  * PHP version 5<br/>  *<br/>  * @category  Phing Task<br/>  * @package   phing<br/>  * @author    Alfonso Jimenez<br/>  * license   <a href="http://www.gnu.org/licenses/gpl.html">http://www.gnu.org/licenses/gpl.html</a> GPL</span><br/><span class="co4">  *<br/>  */</span><br/><span class="kw2">class</span> r3GenerateTask <span class="kw2">extends</span> Task<br/><span class="br0">{</span><br/>     <span class="co4">/**<br/>      * path to r3 workspace<br/>      *<br/>      * var  string<br/>      */</span><br/>     protected <span class="re0">$r3Workspace</span><span class="sy0">;</span><br/><br/>     <span class="co4">/**<br/>      * init method<br/>      *</span><br/><span class="co4">      * @return boolean<br/>      */</span><br/>     <span class="kw2">public</span> <span class="kw2">function</span> init<span class="br0">(</span><span class="br0">)</span><br/>     <span class="br0">{</span><br/>         <span class="kw1">return</span> <span class="kw4">true</span><span class="sy0">;</span><br/>     <span class="br0">}</span><br/><br/>     <span class="co4">/**<br/>      * main method<br/>      *<br/>      * @return void<br/>      */</span><br/>     <span class="kw2">public</span> <span class="kw2">function</span> main<span class="br0">(</span><span class="br0">)</span><br/>     <span class="br0">{</span><br/>         <span class="re0">$command</span> <span class="sy0">=</span> <span class="st_h">'r3 -c '</span><span class="sy0">.</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">Workspace</span> <span class="sy0">.</span><span class="st_h">' generate -av'</span><span class="sy0">;</span><br/>         <span class="re0">$output</span>  <span class="sy0">=</span> <a href="http://http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span><br/>         <span class="re0">$return</span>  <span class="sy0">=</span> <span class="kw4">null</span><span class="sy0">;</span><br/><br/>         try <span class="br0">{</span><br/>             <a href="http://www.php.net/exec"><span class="kw3">exec</span></a><span class="br0">(</span><span class="re0">$command</span><span class="sy0">,</span> <span class="re0">$output</span><span class="sy0">,</span> <span class="re0">$return</span><span class="br0">)</span><span class="sy0">;</span><br/><br/>             <span class="kw1">foreach</span> <span class="br0">(</span><span class="re0">$output</span> <span class="kw1">as</span> <span class="re0">$line</span><span class="br0">)</span> <span class="br0">{</span><br/>                 <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">log</span><span class="br0">(</span><span class="re0">$line</span><span class="sy0">,</span> Project<span class="sy0">::</span><span class="me2">MSG_VERBOSE</span><span class="br0">)</span><span class="sy0">;</span><br/>             <span class="br0">}</span><br/><br/>             <span class="kw1">if</span> <span class="br0">(</span><span class="re0">$return</span> <span class="sy0">!==</span> 0<span class="br0">)</span> <span class="br0">{</span><br/>                 throw <span class="kw2">new</span> BuildException<span class="br0">(</span><span class="st_h">'Task exited with code'</span><span class="sy0">.</span> <span class="re0">$return</span><span class="br0">)</span><span class="sy0">;</span><br/>             <span class="br0">}</span><br/>         <span class="br0">}</span> catch <span class="br0">(</span>BuildException <span class="re0">$e</span><span class="br0">)</span> <span class="br0">{</span><br/><br/>             <span class="re0">$op</span> <span class="sy0">=</span> Project<span class="sy0">::</span><span class="me2">MSG_WARN</span><span class="sy0">;</span><br/><br/>             <span class="kw1">if</span> <span class="br0">(</span><span class="re0">$this</span><span class="sy0">-&amp;</span>gt<span class="sy0">;</span>quiet <span class="sy0">===</span> <span class="kw4">true</span><span class="br0">)</span> <span class="br0">{</span><br/>                 <span class="re0">$op</span> <span class="sy0">=</span> Project<span class="sy0">::</span><span class="me2">MSG_VERBOSE</span><span class="sy0">;</span><br/>             <span class="br0">}</span><br/><br/>             <span class="re0">$this</span><span class="sy0">-&amp;</span>gt<span class="sy0">;</span>log<span class="br0">(</span><span class="re0">$e</span><span class="sy0">-&gt;</span><span class="me1">getMessage</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">,</span> <span class="re0">$op</span><span class="br0">)</span><span class="sy0">;</span><br/>         <span class="br0">}</span><br/>     <span class="br0">}</span><br/><span class="br0">}</span></pre>
</div>
<h2>r3SetVarTask.php</h2>
<div class="codecolorer-container php blackboard">
<pre class="prettyprint lang-php">require_once 'phing/Task.php';<br/><br/>/**<br/> * r3 setVar Task<br/> *<br/> * PHP version 5<br/> *<br/> * category Phing Task<br/> * package phing<br/> * author Alfonso Jimenez &lt;yo@alfonsojimenez.com&gt;<br/> * license <a href="http://www.gnu.org/licenses/gpl.html">http://www.gnu.org/licenses/gpl.html</a> GPL<br/> *<br/> */<br/>class r3SetVarTask extends Task {<br/>    /**<br/>     * path to r3 workspace<br/>     *<br/>     * var string<br/>     */<br/>    protected $r3Workspace;<br/><br/>    /**                                              <br/>     * dimension                                      <br/>     *                                               <br/>     * @var string                                    <br/>     */                                              <br/>    protected $dimension;                            <br/><br/>    /**                                              <br/>     * variable key                                  <br/>     *                                                <br/>     * @var string                                    <br/>     */                                              <br/>    protected $key;                                  <br/><br/>    /**                                              <br/>     * variable value                                <br/>     *                                                <br/>     * @var string                                    <br/>     */                                              <br/>    protected $value;                                <br/><br/>    /**                                              <br/>     * sets the r3 workspace path                    <br/>     *                                                <br/>     * param string $r3Workspace                    <br/>     *                                                <br/>     * return void                                  <br/>     */                                              <br/>    public function setr3Workspace($r3Workspace)      <br/>    {                                                <br/>        $this-&gt;r3Workspace = $r3Workspace;            <br/>    }                                                <br/><br/>    /**                                              <br/>     * sets dimension                                <br/>     *                                                <br/>     * param string $dimension                      <br/>     *                                                <br/>     * return void                                  <br/>     */                                              <br/>    public function setDimension($dimension)          <br/>    {                                                <br/>        $this-&gt;dimension = $dimension;                <br/>    }                                                <br/><br/>    /**                                              <br/>     * sets the variable key                          <br/>     *                                                <br/>     * param string $key                            <br/>     *                                                <br/>     * return void                                  <br/>     */                                              <br/>    public function setKey($key)                      <br/>    {                                                <br/>        $this-&gt;key = $key;                            <br/>    }                                                <br/><br/>    /**                                              <br/>     * sets the variable value                        <br/>     *                                                <br/>     * param string $value                          <br/>     *                                                <br/>     * return void                                  <br/>     */                                              <br/>    public function setValue($value)                  <br/>    {                                                <br/>        $this-&gt;value = $value;                        <br/>    }                                                <br/><br/>    /**<br/>     * init method<br/>     *            <br/>     * @return boolean<br/>     */              <br/>    public function init()<br/>    {                    <br/>        return true;      <br/>    }                    <br/><br/>    /**                  <br/>     * main method        <br/>     *                    <br/>     * @return void      <br/>     */                  <br/>    public function main()<br/>    {                    <br/>        $command = ‘r3 -c ‘. $this‐&gt;r3Workspace .’ var set ‘. $this‐&gt;dimension<br/>                   .’ ‘. $this‐&gt;key .’ ‘. $this‐&gt;value;                      <br/>        $output  = array();                                                  <br/>        $return  = null;                                                      <br/><br/>        try {                                                                <br/>            exec($command, $output, $return);                                <br/><br/>            foreach ($output as $line) {                                      <br/>                $this-&gt;log($line, Project::MSG_VERBOSE);<br/>            }<br/><br/>            if ($return !== 0) {<br/>                throw new BuildException(‘Task exited with code’. $return);<br/>            }<br/>        } catch (BuildException $e) {<br/><br/>            $op = Project::MSG_WARN;<br/><br/>            if ($this-&gt;quiet === true) {<br/>                $op = Project::MSG_VERBOSE;<br/>            }<br/><br/>            $this-&gt;log($e-&gt;getMessage(), $op);<br/>        }<br/>    }<br/>}</pre>
<div class="php codecolorer"></div>
<div class="php codecolorer">If you want to use these tasks in your Phing file, you have to place them in /usr/share/php/phing/extended/tasks/ first. Then you can call them by writing the following <em>tag-commands</em>:</div>
</div>
<p><em>&lt;taskdef name=”r3-generate” classname=”extended.tasks.r3GenerateTask” /&gt;<br/> &lt;taskdef name=”r3-setVar” classname=”extended.tasks.r3SetVarTask” /&gt; </em></p>
<p><em>&lt;r3-generate r3Workspace=”${workspace.dir}”&gt;&lt;/r3&gt;<br/> &lt;r3-setVar r3Workspace=”${workspace.dir}” dimension=”${dimension}” key=”var_key” value=”${var_value}”&gt;&lt;/r3&gt;</em></p>
<p>Let’s see an example of a real <strong>Phing</strong> file. Imagine that we have to write a task which needs to do the following steps:</p>
<ol><li>Get a <strong>Yahoo r3</strong> workspace from a SVN repository (<em><a href="http://svn.test.com/trunk/r3">http://svn.test.com/trunk/r3</a></em>)</li>
<li>Build the <strong>Yahoo r3</strong> workspace</li>
<li>Move the generated templates into a certain directory</li>
<li>Clean up the temporary files</li>
</ol><p>So we can straightforward write a <strong>Phing</strong> task in order to follow this sequence of steps:</p>
<div class="codecolorer-container php blackboard">
<div class="php codecolorer"><span class="sy1">&lt;?</span>xml version<span class="sy0">=</span><span class="st0">&ldquo;1.0&rdquo;</span><span class="sy1">?&gt;</span><br/> &lt;project name=&ldquo;Yahoo r3 Templates Build&rdquo; basedir=&ldquo;.&rdquo; default=&ldquo;build&rdquo;&gt;<br/><br/>    &lt;property name=&ldquo;tmp.dir&rdquo; value=&ldquo;/tmp/template&rdquo; /&gt;<br/>    &lt;property name=&ldquo;templates.dir&rdquo; value=&ldquo;/home/r3/templates&rdquo; /&gt;<br/>    &lt;property name=&ldquo;svn&rdquo; value=&ldquo;http://svn.test.com/trunk/r3&rdquo; /&gt;<br/><br/>    &lt;target name=&ldquo;build&rdquo; depends=&ldquo;init, generate, clean&rdquo; /&gt;<br/><br/>    &lt;target name=&ldquo;init&rdquo;&gt;<br/>       &lt;taskdef name=&ldquo;r3-generate&rdquo; classname=&ldquo;extended.tasks.r3GenerateTask&rdquo; /&gt;<br/><br/>       &lt;mkdir dir=&ldquo;${tmp.dir}&rdquo; /&gt;<br/>       &lt;svncheckout svnpath=&ldquo;/usr/bin/svn&rdquo; repositoryurl=&ldquo;${svn}&rdquo; todir=&ldquo;${tmp.dir}&rdquo;/&gt;<br/>    &lt;/target&gt;<br/><br/>    &lt;target name=&ldquo;generate&rdquo;&gt;<br/>       &lt;r3-generate r3Workspace=&ldquo;${tmp.dir}&rdquo;&gt;&lt;/r3-generate&gt;<br/>    &lt;/target&gt;<br/><br/>    &lt;target name=&ldquo;clean&rdquo;&gt;<br/>       &lt;copy todir=&ldquo;${templates.dir}&rdquo;&gt;<br/>         &lt;fileset dir=&ldquo;${tmp.dir}/htdocs&rdquo;&gt;<br/>            &lt;include name=&ldquo;**&rdquo; /&gt;<br/>         &lt;/fileset&gt;<br/>       &lt;/copy&gt;<br/><br/>       &lt;delete dir=&ldquo;${tmp.dir}&rdquo; includeemptydirs=&ldquo;true&rdquo; failonerror=&ldquo;true&rdquo; /&gt;<br/>    &lt;/target&gt;<br/> &lt;/project&gt;</div>
</div>
